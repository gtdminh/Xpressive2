var Xmpp;(function(n){var t=function(){function t(){}return t.prototype.init=function(n){Strophe.debug("init muc plugin"),this._connection=n,this._servers=null,Strophe.addNamespace("MUC_USER","http://jabber.org/protocol/muc#user"),Strophe.addNamespace("MUC_OWNER","http://jabber.org/protocol/muc#owner"),Strophe.addNamespace("X_DATA","jabber:x:data")},t.prototype.statusChanged=function(t){t===Strophe.Status.CONNECTED?(this._servers=new n.Servers(this._connection),this._connection.addHandler(this.handlePresence.bind(this),Strophe.NS.MUC_USER,"presence")):t===Strophe.Status.DISCONNECTED&&(this._servers=null)},t.prototype.processDiscoItems=function(n){var i=$(n),t,r,u=i.find("item").each(function(n,i){if($(i).attr("name")==="conference"){t=$(i).attr("jid");return}});t&&this._servers.addServerAndGetInfo(t)},t.prototype.join=function(n,t,i){var r=this._servers.getRoom(n);r.join(t,i)},t.prototype.leave=function(n){var t=this._servers.getRoom(n);t.leave()},t.prototype.isRoomSecure=function(n){var t=this._servers.getRoom(n);return t?t.requiresPassword():!0},t.prototype.handlePresence=function(n){var s,r=$(n),e=r.attr("type"),i=r.attr("from"),u=this._servers.getRoom(i),h,f,o,t;if(e==="error"){if(f=r.find("error"),f.length>0){o=f.attr("type"),t=f.next().prop("tagName"),Strophe.error("MUC presence error: type="+o+", code="+t);switch(o){case"auth":switch(t){}break;case"cancel":switch(t){}break;case"wait":switch(t){}break;case"modify":switch(t){}}}}else if(u&&u.isConfigured){if(Strophe.info("[MUC] Presence received for: "+i),s=Strophe.getResourceFromJid(i),s===u.myNickname&&e==="unavailable")return $(document).trigger("I_have_left_room",u),!0;if(h=this._servers.updatePresence(r),e==="unavailable")return!0;$(document).trigger("update_room_occupants",h)}else Strophe.info("[MUC] Presence for new room: "+i),this._requestRoomForm(i);return!0},t.prototype._requestRoomForm=function(n){var t=this,i=$iq({type:"get",to:Strophe.getBareJidFromJid(n)}).c("query",{xmlns:Strophe.NS.MUC_OWNER});this._connection.sendIQ(i,function(n){t._formRequestHandler(n)},function(n){t._formRequestErrorHandler(n)})},t.prototype._formRequestHandler=function(n){var t=this;$(document).trigger("create_room_form",{iq:n,onOk:function(n,i){t.configureThisRoom(n,i)},onCancel:function(n){t.cancelThisRoom(n)}})},t.prototype._formRequestErrorHandler=function(){Strophe.error("Create Room Form request failed.")},t.prototype.configureThisRoom=function(t,i){var r=this,u=n.Form.fromHTML(i),f,e;u.type="submit",f=u.toXML(),e=$iq({to:$(t).attr("from"),type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).cnode(f),this._connection.sendIQ(e.tree(),function(n){r.on_configure_room_result(n)},function(n){r.on_create_room_error.bind(n)})},t.prototype.cancelThisRoom=function(n){var t=$(n).attr("from"),i=$iq({to:t,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:Strophe.NS.X_DATA,type:"cancel"});this._connection.sendIQ(i.tree())},t.prototype.on_configure_room_result=function(n){var i=$(n).attr("from"),t;this.refreshInfo(i),t=this.getRoom(i),t.isConfigured||(t.isConfigured=!0,t.rejoin())},t.prototype.on_create_room_error=function(){},t.prototype.refreshInfo=function(n){this._servers.getRoom(n).getInfo()},t.prototype.isServer=function(n){var t=this._servers.getServer(n);return t?!0:!1},t.prototype.getOrAddRoom=function(n){return this._servers.getOrAddRoom(n)},t.prototype.getRoom=function(n){return this._servers.getRoom(n)},t.prototype.createRoom=function(t,i){var f=this._servers.getMyServer(),r=t+"@"+f.serverJid,u=new n.Room(r,"["+t+"]...not configured",this._connection),e;u.isConfigured=!1,u.myNickname=i,f.rooms[r]=u,e=$pres({to:r+"/"+i}).c("x",{xmlns:Strophe.NS.MUC}),this._connection.send(e)},t.prototype.destroyRoom=function(n,t,i,r){this._servers.destroyRoom(n,t,i,r)},t.prototype.configureRoom=function(n){this._requestRoomForm(n)},t}();n.Muc=t})(Xmpp||(Xmpp={})),Strophe.addConnectionPlugin("muc",function(){var n=new Xmpp.Muc;return{init:function(t){return n.init(t)},statusChanged:function(t){return n.statusChanged(t)},processDiscoItems:function(t){return n.processDiscoItems(t)},join:function(t,i,r){return n.join(t,i,r)},leave:function(t){return n.leave(t)},isServer:function(t){return n.isServer(t)},isRoomSecure:function(t){return n.isRoomSecure(t)},getRoom:function(t){return n.getRoom(t)},getOrAddRoom:function(t){return n.getOrAddRoom(t)},createRoom:function(t,i){return n.createRoom(t,i)},destroyRoom:function(t,i,r,u){return n.destroyRoom(t,i,r,u)},refreshInfo:function(t){return n.refreshInfo(t)},handlePresence:function(t){return n.handlePresence(t)},configureRoom:function(t){return n.configureRoom(t)}}}())
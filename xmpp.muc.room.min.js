var Xmpp;(function(n){var t=function(){function t(n,t,i){this.joined=!1,this.isConfigured=!0,this.chatSession=null,this.jid=Strophe.getBareJidFromJid(n),this.myNickname="",this.myAffiliation="none",this.myRole="none",this.connection=i,this.roomName=t,this.roomInfoResponse={},this.occupants=[],this.joined=!1,this.presenceResponse={},this.form={},this.isConfigured=!0,this.chatSession=null,Strophe.info("new room created: "+this.jid)}return t.prototype.canModifySubject=function(){var t,n;return this.roomInfoResponse&&(n=$(this.roomInfoResponse).find('field[var="muc#roominfo_subjectmod"]'),n&&(t=$(n).find("value").text(),t==="1"))?!0:this.iAmAdmin()?!0:!1},t.prototype.getInfo=function(){Strophe.info("Room: get room info for: "+this.jid);var n={xmlns:Strophe.NS.DISCO_INFO},t=$iq({to:this.jid,type:"get"}).c("query",n);this.connection.sendIQ(t,this.roomInfoResult.bind(this),this.roomInfoError.bind(this))},t.prototype.roomInfoResult=function(t){Strophe.info("got room info for: "+this.jid),this.roomInfoResponse=t;var i=$(t).find("identity").attr("name");i&&this.roomName!==i&&(this.roomName=i,$(document).trigger("roomname_changed",this)),Strophe.info("Room Description: "+this.description()),Strophe.info("Number Of Occupants: "+this.numberOfOccupants()),this.form=n.Form.fromXML($(t).find("x")),$(document).trigger("room_changed",this)},t.prototype.roomInfoError=function(){Strophe.error("Room ERROR: for room info: "+this.jid)},t.prototype.description=function(){var n="xx";return this.roomInfoResponse&&$(this.roomInfoResponse).find("x field").each(function(){if($(this).attr("var")==="muc#roominfo_description"){n=$(this).find("value").text();return}}),n},t.prototype.numberOfOccupants=function(){var n=-1;return this.roomInfoResponse&&$(this.roomInfoResponse).find("x field").each(function(){if($(this).attr("var")==="muc#roominfo_occupants")return n=parseInt($(this).find("value").text())}),n},t.prototype.rejoin=function(){this.chatSession=this.connection.chat.joinRoomChat(this)},t.prototype.join=function(n,t){var r,i,u;if(this.chatSession){$(document).trigger("set_focus_on_tab",this.jid);return}Strophe.info("Room: join room: "+this.jid),this.myNickname=n,$(document).trigger("join_room",this),r=t?t.trim():"",i=$pres({to:this.jid+"/"+this.myNickname}).c("x",{xmlns:Strophe.NS.MUC}),r.length>0&&i.c("password",null,r),u=this.connection.caps.createCapsNode().tree(),i.up().cnode(u),this.connection.send(i.tree()),this.chatSession=this.connection.chat.joinRoomChat(this),this.getInfo()},t.prototype.leave=function(){Strophe.info("leave room: "+this.jid);var n=$pres({to:this.jid+"/"+this.myNickname,type:"unavailable"});this.connection.send(n),this.getInfo(),this.chatSession=null,this.occupants=[]},t.prototype.sendMessage=function(n){Strophe.info("send message to room: "+this.jid);var t=$msg({to:this.jid,type:"groupchat"}).c("body").t(n);this.connection.send(t)},t.prototype.incomingMucMessage=function(n){var i,t,r;return Strophe.info("got message for room: "+this.jid),t=$(n).find("delay"),t.length===0&&(t=$(n).find("x")),t.length!==0&&(r=t.attr("stamp"),i=new Date(r)),this.chatSession.recvMessage(n,i),i},t.prototype.inviteReceived=function(n,t,i,r){Strophe.info("got invite for room: "+this.jid),$(document).trigger("prompt_for_invite_response",{fromJid:n,fromName:t,reason:i,password:r,roomJid:this.jid,roomName:this.roomName,accept:this.acceptInvite.bind(this),decline:this.declineInvite.bind(this),ignore:null})},t.prototype.requiresPassword=function(){var n=!0;return this.roomInfoResponse&&$(this.roomInfoResponse).find("feature").each(function(){if($(this).attr("var")==="muc_unsecured"){n=!1;return}}),n},t.prototype.iAmModerator=function(){return this.myRole==="moderator"},t.prototype.iAmOwner=function(){return this.myAffiliation==="owner"},t.prototype.iAmMember=function(){return this.iAmModerator||this.myRole==="participant"},t.prototype.iAmAdmin=function(){return this.iAmOwner||this.myAffiliation==="administrator"},t.prototype.iAmBanned=function(){return!1},t.prototype.iHaveVoice=function(){return!0},t.prototype.iCanInvite=function(){return!0},t.prototype.queryOccupants=function(){var n,t;n={xmlns:Strophe.NS.DISCO_ITEMS},t=$iq({from:this.connection.jid,to:this.jid,type:"get"}).c("query",n),this.connection.sendIQ(t,this._occupantsInfo.bind(this),this._errorInfo.bind(this))},t.prototype._occupantsInfo=function(n){Strophe.info("Room: got occupants info for: "+this.jid);var t=$(n)},t.prototype._errorInfo=function(n){Strophe.info("Room ERROR: for occupants info for: "+this.jid);var t=$(n)},t.prototype.addOccupant=function(n,t){return this._addOccupant(n,t)},t.prototype._addOccupant=function(t,i){var r=this.findOccupant(t);return r||(r=new n.Occupant(t),this.occupants[r.nickname]=r),r.presenceUpdate(i),r.isThisMe()||$(document).trigger("someone_has_joined_room",r),r},t.prototype.findOccupant=function(n){var t=Strophe.getResourceFromJid(n);return this.occupants[t]},t.prototype.removeOccupant=function(n){Strophe.info("Room: remove occupant from room: "+n);var t=Strophe.getResourceFromJid(n);return $(document).trigger("someone_has_left_room",this.occupants[t]),delete this.occupants[t],!0},t.prototype.updateOccupant=function(n){var t=$(n).attr("from");return Strophe.info("Room: update room occupant: "+t),this._addOccupant(t,n)},t.prototype.invite=function(){$(document).trigger("send_invitation",{room:this,okHandler:this.sendInvite.bind(this)})},t.prototype.sendInvite=function(n){var t=$msg({to:this.jid}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:n.jid});n.reason&&t.c("reason").t(n.reason).up(),n.password&&t.up().c("password").t(n.password),this.connection.send(t.tree())},t.prototype.acceptInvite=function(n,t){this.join(n,t)},t.prototype.declineInvite=function(n,t,i){var r=$msg({to:n}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("decline",{to:t});i&&r.c("reason").t(i),this.connection.send(r.tree())},t}();n.Room=t})(Xmpp||(Xmpp={}))
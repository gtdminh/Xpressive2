var Xmpp;(function(n){var i=function(){function n(n,t){this.message=n,this.timestamp=t||new Date}return n}(),t;n.Message=i,t=function(){function t(){}return t.prototype.init=function(n){Strophe.debug("init chat plugin"),this._connection=n,this._chatSessions=[],this._roster=null,this._muc=[],this._connection.addHandler(this.incomingMessage.bind(this),null,"message")},t.prototype.statusChanged=function(n){n===Strophe.Status.CONNECTED&&(this._roster=this._connection.roster,this._muc=this._connection.muc,this._chatSessions=[])},t.prototype.chatTo=function(t){var i=null,r=null,u;if(t){for(u in t.resources){r=u;break}i=new n.ChatSession(t,t.name,r,this._connection),t.chatSession=i,Strophe.info("Start chat with: "+t.name+"("+t.jid+")"),this._addChatSessionAndStartChatting(t.jid,i)}return i},t.prototype.joinRoomChat=function(t){var i=new n.ChatSession(t,t.roomName,null,this._connection);return i.isGroupChat=!0,Strophe.info("Start room chat: "+t.jid),this._addChatSessionAndStartChatting(t.jid,i),i},t.prototype._addChatSessionAndStartChatting=function(n,t){this._chatSessions[n]=t,$(document).trigger("start_chatting",t)},t.prototype.sendNewTopic=function(n,t){var i=$msg({to:n,type:"groupchat"}).c("subject").t(t).up(),r=this._chatSessions[n]||null;r&&(Strophe.info("Topic change sent to: "+n),i=r.sendTopic(i))},t.prototype.sendNewMessage=function(n,t,i,r){var u={},f,o=n,e;r?u=$msg({to:n,type:"groupchat"}).c("body").t(i).up():(t&&(o=n+"/"+t),u=$msg({to:o,type:"chat"}).c("body").t(i).up()),f=this._chatSessions[n]||null,f&&(Strophe.info("New chat message sent to: "+n),e=new Date,u=f.sendMessage(u,e),f.isGroupChat===!1&&$(document).trigger("new_chat_message",{message:u,timestamp:e,fromMe:!0}))},t.prototype.incomingMessage=function(t){var i=$(t),u=i.attr("from"),f=Strophe.getBareJidFromJid(u),o=this._chatSessions[f]||null,s=i.attr("type")||"normal",r,h,e,w,c,a,v,k,d,y,g,p;if(s==="normal")if(c=i.find("invite"),c.length>0){var nt=u,l=c.attr("from"),b=i.find("password");e=this._muc.getOrAddRoom(nt),r=this._roster.findContact(Strophe.getBareJidFromJid(l)),e.inviteReceived(l,r?r.name:Strophe.getNodeFromJid(l),c.text(),b.length>0?b.text():null)}else a=i.find("body"),a.length>0&&(v=i.find("subject"),v&&(k=v.text()),d=a.text(),$(document).trigger("urgent_message",{from:Strophe.getNodeFromJid(i.attr("from")),jid:i.attr("from"),subject:k,messageText:d,replyHandler:this.sendOneOffMessage.bind(this)}));else if(s==="error")y=i.find("error"),g=y.children()[0].nodeName,Strophe.warn("Message type=error recv'd: code="+y.attr("code")+", reason="+g);else{if(s==="groupchat"){if(e=o.chatWith,e==null)return!0;w=e.incomingMucMessage(t)}else s==="chat"&&(o?o.recvMessage(i):(Strophe.info("Start chat requested by: "+Strophe.getBareJidFromJid(u)),e=null,e?(h=Strophe.getResourceFromJid(u),f=u,r=new n.Contact(null,f)):(f=Strophe.getBareJidFromJid(u),r=this._roster.findContact(f),r?h=r.name:(r=new n.Contact(null,f),p=i.find("nick"),h=p?$(p).text():Strophe.getNodeFromJid(u),r.name=h)),o=new n.ChatSession(r,h,Strophe.getResourceFromJid(u),this._connection,i),this._addChatSessionAndStartChatting(f,o)));$(document).trigger("new_chat_message",{message:i,fromMe:!1,timestamp:w,type:s})}return!0},t.prototype.sendOneOffMessage=function(n,t,i){var r=$msg({type:"normal",to:n});t&&r.c("subject").text(t).up(),r.c("body").t(i),this._connection.Send(r.tree())},t.prototype.endSession=function(n){var t=this._chatSessions[n];t.endChat(),delete this._chatSessions[n]},t}(),n.Chat=t})(Xmpp||(Xmpp={})),Strophe.addConnectionPlugin("chat",function(){var n=new Xmpp.Chat;return{init:function(t){return n.init(t)},statusChanged:function(t){return n.statusChanged(t)},chatTo:function(t){return n.chatTo(t)},joinRoomChat:function(t){return n.joinRoomChat(t)},sendNewMessage:function(t,i,r,u){return n.sendNewMessage(t,i,r,u)},sendNewTopic:function(t,i){return n.sendNewTopic(t,i)},incomingMessage:function(t){return n.incomingMessage(t)},endSession:function(t){return n.endSession(t)}}}())
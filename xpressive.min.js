var Xmpp,Xpressive;(function(n){var t=function(){function t(n){this.strophe=n,this.settings=null}return Object.defineProperty(t.prototype,"Session",{get:function(){return this.connection.session},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Me",{get:function(){return this.connection.me},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Chat",{get:function(){return this.connection.chat},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Muc",{get:function(){return this.connection.muc},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Roster",{get:function(){return this.connection.roster},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Chatstates",{get:function(){return this.connection.chatstates},enumerable:!0,configurable:!0}),t.prototype.sessionDisconnect=function(){this.Session.disconnect()},t.prototype.getMyNickname=function(){return this.Me.getNickname()},t.prototype.changeStatus=function(n,t){return this.Me.changeStatus(n,t)},t.prototype.endSession=function(n){return this.Chat.endSession(n)},t.prototype.getRoom=function(n){return this.Muc.getRoom(n)},t.prototype.destroyRoom=function(n,t,i,r){return this.Muc.destroyRoom(n,t,i,r)},t.prototype.refreshInfo=function(n){return this.Muc.refreshInfo(n)},t.prototype.configureRoom=function(n){this.Muc.configureRoom(n)},t.prototype.findContact=function(n){return this.Roster.findContact(n)},t.prototype.chatTo=function(n){var t=this.Roster.chatTo(n);t&&this.Chat.chatTo(t)},t.prototype.chatToDirect=function(n){var t=this.Roster.chatToDirect(n);t&&this.Chat.chatTo(t)},t.prototype.addContact=function(n,t,i){return typeof i=="undefined"&&(i=null),this.Roster.addContact(n,t,i)},t.prototype.modifyContact=function(n,t,i){return typeof i=="undefined"&&(i=null),this.Roster.modifyContact(n,t,i)},t.prototype.deleteContact=function(n){return this.Roster.deleteContact(n)},t.prototype.jid_to_id=function(n){return n?this.strophe.getBareJidFromJid(n).replace("@","-").replace(/\./g,"-"):""},t.prototype.occupantJid_to_id=function(n){return n.replace("@","-").replace("/","-").replace(/\./g,"-")},t.prototype.log=function(n){try{$("#console .log-messages").append("<div><span class='log'>"+n+"<\/span><\/div>")}catch(t){console.log(t)}},t.prototype.getSettings=function(){try{return this.settings||(this.settings=$.jStorage.get("Settings"),this.settings||$("#settings_dialog").dialog("open")),this.settings}catch(n){console.log(n)}},t.prototype.setSettings=function(n){var t=this;try{$.each(n,function(n,i){t.settings||(t.settings={}),t.settings[n]=i}),$.jStorage.set("Settings",this.settings)}catch(i){console.log(i)}},t.prototype.getSetting=function(n){return this.getSettings()[n]},t.prototype.setSetting=function(n,t){this.setSettings({key:t})},t.prototype.updateRoomName=function(n,t){var i=this.jid_to_id(n);$('#chat-area > ul a[href="#chat-'+i+'"]').text(t)},t.prototype.updateContactName=function(n,t){var i=this.jid_to_id(n);$('#roster-area > ul a[href="#'+i+'"]').text(t)},t.prototype.do_presence_changed=function(n){var t,r,i,u;if(n===undefined)return!0;if(t="online",r=this.jid_to_id(n.jid),this.log("Got presence from: "+n.jid),i=$("#roster-area li#"+r+" div.roster-contact"),i){if(i.removeClass("online").removeClass("away").removeClass("chat").removeClass("xa").removeClass("dnd").removeClass("offline"),n.online())for(u in n.resources){t=n.resources[u].show||"online";break}else t="offline";i.addClass(t)}return!0},t.prototype.do_ask_subscription=function(n){$("#approve_dialog").dialog("option","jid",n),$("#approve_dialog").dialog("open")},t.prototype.do_rooms_changed=function(n){this.log("Got rooms update:");for(var t in n.rooms)this.do_room_changed(n.rooms[t])},t.prototype.do_room_changed=function(n){var i=this.jid_to_id(n.jid),r=n.numberOfOccupants(),t="<li id='"+i+"'><div class='room-entry'><div class='room-name'><span style='display:inline-block;'>"+n.roomName+"<\/span>",u;if(n.requiresPassword()&&(t+="&nbsp;<img class='ui-icon ui-icon-key xmpp-protected' style='display:inline-block; vertical-align:bottom;'/><div class='tooltip'>Password required<\/div>"),t+="&nbsp;<img class='ui-icon ui-icon-pencil xmpp-configure-room' style='display:inline-block; vertical-align:bottom;'/><div class='tooltip'>Modify Room Settings.<\/div>",n.iAmModerator()&&(t+="&nbsp;<img class='ui-icon ui-icon-person xmpp-moderator' style='display:inline-block; vertical-align:bottom;'/><div class='tooltip'>You are a moderator<\/div>"),t+="&nbsp;<img class='ui-icon ui-icon-close xmpp-destroy-room' style='display:inline-block; vertical-align:bottom;'/><div class='tooltip'>Delete this Room.<\/div>",t+="<img class='ui-icon ui-icon-refresh xmpp-refresh-room' style='display:inline-block; vertical-align:bottom;'/><div class='tooltip'>Click to refresh info<\/div><img class='ui-icon ui-icon-play xmpp-join-room' style='display:inline-block; vertical-align:bottom;'/><div class='tooltip'>Click to join<\/div>",t+="<\/div>",t+="<div class='room-jid'>"+n.jid+"<\/div><div><ul id='"+i+"-occupants' class='occupants-list",r===0&&(t+=" hidden"),t+="'><div style='display:inline-block;'><img class='ui-icon ui-icon-person xmpp-occupantCount' style='display:inline-block; vertical-align:bottom;'/><span style='font-size:75%; vertical-align:center;'>("+r+") Room Occupants<\/span><\/div>",r!==0)for(u in n.occupants)t+=this._getOccupantHtml(n.occupants[u]);t+="<\/ul><\/div><\/div><\/li>",this.insert_room(i,$(t))},t.prototype.do_update_room_occupant=function(n){var i=n.fullJid,u=Strophe.getBareJidFromJid(i),f=this.jid_to_id(u)+"-occupants",e=this.occupantJid_to_id(i),o=$("ul#"+f),r=this._getOccupantHtml(n),t;Strophe.debug("Update occupants: "+n.toString()),t=$("li#"+e),t&&t.length>0?t.replaceWith(r):o.append($(r))},t.prototype.do_remove_room_occupant=function(n){var i=Strophe.getBareJidFromJid(n),r=this.jid_to_id(i)+"-occupants",u=this.occupantJid_to_id(n),f=$("ul#"+r),t;Strophe.debug("Remove occupant: "+n),t=$("li#"+u),t&&t.length>0&&t.remove()},t.prototype.do_clear_room_occupants=function(n){var t=this.jid_to_id(n.jid)+"-occupants",i=$("ul#"+t);i.empty()},t.prototype._getOccupantHtml=function(n){var r=n.fullJid,u=this.occupantJid_to_id(r),t="",i=n.getStatus();return n.thisIsMe?t=" *me*":i.length>0&&(t=" ["+i+"]"),"<li id='"+u+"'>"+n.nickname+t+"<\/li>"},t.prototype.do_confirm_action=function(n){$("#confirmation_dialog").dialog("option","title",n.title),$("#confirmation_dialog").dialog("option","message",n.message),$("#confirmation_dialog").dialog("option","okHandler",n.onOk),$("#confirmation_dialog").dialog("option","cancelHandler",n.onCancel),$("#confirmation_dialog").dialog("option","hideReason",n.hideReason),$("#confirmation_dialog").dialog("option","userData",n.userData),$("#confirmation_dialog").dialog("open")},t.prototype.do_destroy_room=function(n){$("#destroyRoom_dialog").dialog("option","title",n.title),$("#destroyRoom_dialog").dialog("option","message",n.message),$("#destroyRoom_dialog").dialog("option","okHandler",n.onOk),$("#destroyRoom_dialog").dialog("option","cancelHandler",n.onCancel),$("#destroyRoom_dialog").dialog("option","userData",n.userData),$("#destroyRoom_dialog").dialog("open")},t.prototype.do_create_room=function(n){$("#form_dialog").dialog("option","title","Configure Room ["+$(n.iq).attr("from")+"]"),$("#form_dialog").dialog("option","formIQ",n.iq),$("#form_dialog").dialog("option","okHandler",n.onOk),$("#form_dialog").dialog("option","cancelHandler",n.onCancel),$("#form_dialog").dialog("open")},t.prototype.do_update_info=function(n){var t=n.jid,i=this.jid_to_id(t),r="#"+i;$(r+" #contact_info").text(n.getInfo())},t.prototype.do_roster_changed=function(n){var f,o,h,u,c,e,i;this.log("Got roster update:"),f=n.list;for(o in f){var t=f[o],s=t.subscription,l=t.name||Strophe.getNodeFromJid(t.jid),r=this.jid_to_id(t.jid);if(this.log("    jid: "+t.jid+"["+s+"]"),s==="remove")$("#roster-area li#"+r).remove();else{if(h=t.getGroups(),u="online",t.online())for(c in t.resources){u=t.resources[c].show||"online";break}else u="offline";e="#"+r,i="<li id='"+r+"'><div class='roster-contact "+u+"'><div class='roster-name' style='display:inline-block;'>"+l+"<\/div>",i+="&nbsp;<img class='ui-icon ui-icon-info xmpp-contact-info' style='display:inline-block; vertical-align:bottom;'/><div id='contact_info' class='tooltip'>"+t.getInfo()+"<\/div>",t.subscription!=="both"&&(i+="&nbsp;<img class='ui-icon ui-icon-lightbulb xmpp-change-details' style='display:inline-block; vertical-align:bottom;'/><div class='tooltip'>Subscription pending.<\/div>"),i+="&nbsp;<img class='ui-icon ui-icon-pencil xmpp-change-details' style='display:inline-block; vertical-align:bottom;'/><div class='tooltip'>Modify details.<\/div>&nbsp;<img class='ui-icon ui-icon-close xmpp-remove-contact' style='display:inline-block; vertical-align:bottom;'/><div class='tooltip'>Remove contact<\/div>&nbsp;<img class='ui-icon ui-icon-play xmpp-chat-to' style='display:inline-block; vertical-align:bottom;'/><div class='tooltip'>Start chat<\/div><div class='roster-jid'>"+t.jid+"<\/div><div class'roster-groups'>Groups: "+h+"<\/div><\/div><\/li>",$(e).length>0?$(e).replaceWith(i):this.insert_contact(r,i)}}return!0},t.prototype.do_log_chat_event=function(n,t){var r=t.jid,i;switch(n){case"join":i=t.name+" has joined.";break;case"leave":i=t.name+" has left.";break;case"subject":i=t.name+" has changed the topic to '"+t.topic+"'";break;default:i=n+" is unhandled."}this.on_chat_event(i,r,t.timestamp||new Date)},t.prototype.do_send_invite=function(n){$("#sendInvite_dialog").dialog("option","room",n.room),$("#sendInvite_dialog").dialog("option","cancelHandler",null),$("#sendInvite_dialog").dialog("option","okHandler",n.okHandler),$("#sendInvite_dialog").dialog("open")},t.prototype.do_prompt_room_invite=function(n){$("#roomInvitation_dialog").dialog("option","roomJid",n.roomJid),$("#roomInvitation_dialog").dialog("option","roomName",n.roomName),$("#roomInvitation_dialog").dialog("option","fromJid",n.fromJid),$("#roomInvitation_dialog").dialog("option","fromName",n.fromName),$("#roomInvitation_dialog").dialog("option","password",n.password),$("#roomInvitation_dialog").dialog("option","reason",n.reason),$("#roomInvitation_dialog").dialog("option","accept",n.accept),$("#roomInvitation_dialog").dialog("option","decline",n.decline),$("#roomInvitation_dialog").dialog("option","ignore",n.ignore),$("#roomInvitation_dialog").dialog("open")},t.prototype.updateRoomData=function(n,t,i){var u=this.jid_to_id(Strophe.getBareJidFromJid(n)),r="#chat-"+u;$("#chat-area "+r+" #affil-value").text(t),$("#chat-area "+r+" #role-value").text(i),t==="none"?$("#chat-area "+r+" #affil-img").addClass("hidden"):($("#chat-area "+r+" #affil-img").removeClass("hidden"),$("#chat-area "+r+" #affil-tooltip").text(t+" actions...")),i==="none"?$("#chat-area "+r+" #role-img").addClass("hidden"):($("#chat-area "+r+" #role-img").removeClass("hidden"),$("#chat-area "+r+" #role-tooltip").text(i+" actions..."))},t.prototype.on_start_chat=function(n,t,i,r){var o=this.jid_to_id(n),f="chat-"+o,u="#"+f,e;t||(t=Strophe.getNodeFromJid(n));var c=Strophe.getBareJidFromJid(n),s=Strophe.getResourceFromJid(n),h=$("#chat-area "+u)[0];h||($("#chat-area").tabs("add",u,t),$('#chat-area li[aria-controls="'+f+'"]').append("<span class='ui-icon ui-icon-close'>Remove Tab<\/span>"),i&&(e="<div class='groupchat-header'><div><span id='topic-label'>Topic : <input type='text' class='chat-topic' /><\/span><\/div><div><span id='affil-label'>Affiliation : <\/span><span id='affil-value' class='capitalize'>"+r.myAffiliation+"<\/span><span id='affil-img'>&nbsp;<img class='ui-icon ui-icon-play xmpp-affil-actions' style='display:inline-block; vertical-align:bottom;'/><div id='affil-tooltip' class='tooltip capitalize'>Affiliation Actions.<\/div><\/span><span id='role-label'>  Role : <\/span><span id='role-value' class='capitalize'>"+r.myRole+"<\/span><span id='role-img'>&nbsp;<img class='ui-icon ui-icon-play xmpp-role-actions' style='display:inline-block; vertical-align:bottom;'/><div id='role-tooltip' class='tooltip capitalize'>Role Actions.<\/div><\/span><span id='invite-label'>Invite<\/span><span id='invite-img'>&nbsp;<img class='ui-icon ui-icon-play xmpp-invite-actions' style='display:inline-block; vertical-align:bottom;'/><div id='invite-tooltip' class='tooltip capitalize'>Invite someone to join.<\/div><\/span><\/div><\/div>",$(u).append(e)),$(u).append("<div class='chat-messages' ><\/div><input type='text' class='chat-input'/>"),$(u).data("jid",n),$(u).data("name",t),$(u).data("resource",s),i&&$(u).data("groupChat",i),$(u+" .chat-input").position({of:u,my:"left botton",at:"left bottom",collision:"none"})),$("#chat-area").tabs("select",u),$(u+" input").focus(),$("#client").trigger("resize")},t.prototype.on_join_room=function(n,t,i){this.on_start_chat(Strophe.getBareJidFromJid(n),t,!0,i)},t.prototype.on_chat_event=function(n,t,i){var r=this.jid_to_id(t),u="#chat-"+r;this._add_message(u,t,n,"system",i)},t.prototype.on_message=function(n,t,i){var u,o,y,c,r,f,p,w,e,s,l=!1,h,b=i||new Date,a,v;return t?(s=this.Me.myJid(),u=Strophe.getBareJidFromJid($(n).attr("to")),this.log("Sending message to: "+u),f="Me"):(o=$(n).attr("from"),u=Strophe.getBareJidFromJid(o),this.log("Got message from: "+u)),y=this.jid_to_id(u),c="chat-"+y,r="#"+c,l=$(r).data("groupChat")||!1,s||(s=l?o:u),t||(l?f=Strophe.getResourceFromJid($(n).attr("from")):(p=$(r).data("resource"),p||$(r).data("resource",Strophe.getResourceFromJid(o)),f=$(r).data("name"))),a=$(n).find("subject"),a.length>0?(v=a.text(),$(r+" .chat-topic").val(v),this.do_log_chat_event("subject",{jid:o,name:f,topic:v,timestamp:i})):($(r).length===0&&($("#chat-area").tabs("add",r,Strophe.getNodeFromJid(u)),$('#chat-area li[aria-controls="'+c+'"]').append("<span class='ui-icon ui-icon-close'>Remove Tab<\/span>"),$(r).append("<div class='chat-messages'><\/div><input type='text' class='chat-input'/>")),$("#chat-area").tabs("select",r),$(r+" input").focus(),w=$(n).find("composing"),w.length>0&&($(r+" .chat-messages").append("<div class='chat-event'>"+f+" is typing...<\/div>"),this._scroll_chat(r)),e=$(n).find("html > body"),e.length===0?(e=$(n).find("body"),h=e.length>0?e.text():null):h=e.text(),h&&($(r+" .chat-event").remove(),this._add_message(r,s,h,t?"me":f,b))),!0},t.prototype._add_message=function(t,i,r,u,f){var o=$(t+" ul").last(),s=!0,h,e;o.length>0&&(h=$(t+" ul").last().data("sender"),h===i&&(s=!1)),e=n.Util.formatDate(f,"{FullYear}-{Month:2}-{Date:2} {Hours:2}:{Minutes:2}"),s&&($(t+" .chat-messages").append("<ul class='chat-message"+(u==="me"||u==="system"?" "+u+"'":"'")+"><span class='chat-message-group'><span class='chat-name capitalize'>"+u+"<\/span>:&nbsp;<span class='chat-time'>"+e+"<\/span><\/span><span class='chat-text'><\/span><\/ul>"),o=$(t+" ul").last().data("sender",i)),$(t+" .chat-message:last .chat-text").append("<li>"+r+"<div class='chat-tooltip'>Message time : "+e+"<\/div><\/li>"),this._scroll_chat(t)},t.prototype._scroll_chat=function(n){var t=$(n+" .chat-messages").get(0);t.scrollTop=t.scrollHeight},t.prototype.presence_value=function(n){return n.hasClass("online")?2:n.hasClass("away")?1:0},t.prototype.insert_contact=function(n,t){$("#roster-area ul").append(t)},t.prototype.insert_room=function(n,t){var i=$("#"+n);i.length===0?$("#muc-area ul.room-details").append(t):i.replaceWith(t)},t.prototype.show_incoming=function(n){this.show_traffic(n,"incoming")},t.prototype.show_outgoing=function(n){this.show_traffic(n,"outgoing")},t.prototype.show_traffic=function(n,t){var r=this,i,u;n.childNodes.length>0&&(i=$("#console").get(0),i&&(u=i.scrollTop>=i.scrollHeight-i.clientHeight,$.each(n.childNodes,function(n,i){try{$("#console .log-messages").append("<div><span class='"+t+"'>"+r.pretty_xml(i,0)+"<\/span><\/div>")}catch(u){r.log(u)}}),u&&(i.scrollTop=i.scrollHeight)))},t.prototype.pretty_xml=function(n,t){var o=this,r,i=[],u,f,e;for(t||(t=0),i.push("<div class='xml_level"+t+"'>"),i.push("<span class='xml_punc'>&lt;<\/span>"),i.push("<span class='xml_tag'>"),i.push(n.tagName),i.push("<\/span>"),u=n.attributes,f=[],r=0;r<n.tagName.length+1;r++)f.push("&nbsp;");for(e=f.join(""),r=0;r<u.length;r++)i.push(" <span class='xml_aname'>"),i.push(u[r].nodeName),i.push("<\/span><span class='xml_punc'>='<\/span>"),i.push("<span class='xml_avalue'>"),i.push(u[r].nodeValue),i.push("<\/span><span class='xml_punc'>'<\/span>"),r!==u.length-1&&(i.push("<\/div><div class='xml_level"+t+"'>"),i.push(e));return n.childNodes.length===0?i.push("<span class='xml_punc'>/&gt;<\/span><\/div>"):(i.push("<span class='xml_punc'>&gt;<\/span><\/div>"),$.each(n.childNodes,function(n,r){r.nodeType===1?i.push(o.pretty_xml(r,t+1)):r.nodeType===3&&(i.push("<div class='xml_text xml_level"+(t+1)+"'><span>"),i.push(r.nodeValue),i.push("<\/span><\/div>"))}),i.push("<div class='xml xml_level"+t+"'>"),i.push("<span class='xml_punc'>&lt;/<\/span>"),i.push("<span class='xml_tag'>"),i.push(n.tagName),i.push("<\/span>"),i.push("<span class='xml_punc'>&gt;<\/span><\/div>")),i.join("")},t.prototype.text_to_xml=function(n){var t=null,r,i;if(window.DOMParser)r=new DOMParser,t=r.parseFromString(n,"text/xml");else if(window.ActiveXObject)t=new ActiveXObject("MSXML2.DOMDocument"),t.async=!1,t.loadXML(n);else throw{type:"XpressiveError",message:"No DOMParser object found."};return(i=t.documentElement,$(i).filter("parsererror").length>0)?null:i},t}();n.Xpressive=t})(Xmpp||(Xmpp={})),Xpressive=new Xmpp.Xpressive(Strophe),$(document).ready(function(){$("#chat-area").tabs({animationSpeed:50,resizable:!0,resizeHandles:"e,s,se",easing:"easeInOutExpo"});var n=function(){var n=$(this).height(),t;$(".ui-resize").each(function(t,i){$(i).height(n-84)}),$(".chat-messages").each(function(t,i){var r=$(i).parent().data("groupChat");$(i).height(n-84-(r===!0?118:70))}),$(".log-messages").each(function(t,i){$(i).height(n-129)}),t=$("#chat-area").width(),$(".chat-input").each(function(n,i){$(i).width(t-10),$(i).css({top:"0px"})}),$(".chat-topic").each(function(n,i){$(i).width(t-80)}),$("#muc-area ul.room-details").height(n-144),$("#roster-area ul.contact-details").height(n-144)};$("#client").resizable(),$("#chat-area").tabs().find(".ui-tabs-nav").sortable({axis:"x"}),$(".ui-resizable").resize(n),$("#filter").val("Filter...").addClass("empty"),$("#filter").focus(function(){$(this).val()==="Filter..."&&$(this).val("").removeClass("empty")}),$("#filter").blur(function(){$(this).val()===""&&$(this).val("Filter...").addClass("empty")}),Strophe.log=function(n,t){var i="CUSTOM";switch(n){case 0:i="DEBUG";break;case 1:i="INFO";break;case 2:i="WARN";break;case 3:i="ERROR";break;case 4:i="FATAL"}Xpressive.log(i+": "+t)},Xpressive.getSettings()&&$("#login_dialog").dialog("open")})